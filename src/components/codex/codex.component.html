<div class="h-full w-full bg-gray-800 flex flex-col animate-fadeIn overflow-hidden">
  
  <header class="p-4 border-b-2 border-gray-700/50 flex-shrink-0 text-center">
    <h1 class="text-3xl font-orbitron text-blue-400">Codex</h1>
    <p class="text-gray-400">Discover and collect all the heroes, pets, and resources in the universe.</p>
  </header>

  <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
    <!-- Left Sidebar: Filters & Navigation -->
    <aside class="w-full md:w-64 flex-shrink-0 bg-gray-900/50 p-3 flex flex-col gap-4 border-b-2 md:border-b-0 md:border-r-2 border-gray-700/50">
      <!-- Tabs -->
      <nav class="flex flex-col gap-1">
        <button (click)="setActiveTab('heroes')" class="w-full text-left px-3 py-2 text-sm rounded-md font-semibold flex items-center justify-between" [class.bg-blue-600/50]="activeTab() === 'heroes'" [class.text-white]="activeTab() === 'heroes'" [class.hover:bg-gray-700]="activeTab() !== 'heroes'" [class.text-gray-300]="activeTab() !== 'heroes'">
          <div class="flex items-center gap-2">
            @if(newlyUnlockedHeroIds().size > 0) { <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span> }
            <span>Heroes</span>
          </div>
          <span class="text-xs">{{ heroProgress().unlocked }} / {{ heroProgress().total }}</span>
        </button>
        <button (click)="setActiveTab('pets')" class="w-full text-left px-3 py-2 text-sm rounded-md font-semibold flex items-center justify-between" [class.bg-blue-600/50]="activeTab() === 'pets'" [class.text-white]="activeTab() === 'pets'" [class.hover:bg-gray-700]="activeTab() !== 'pets'" [class.text-gray-300]="activeTab() !== 'pets'">
          <div class="flex items-center gap-2">
            @if(newlyUnlockedPetIds().size > 0) { <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span> }
            <span>Pets</span>
          </div>
          <span class="text-xs">{{ petProgress().unlocked }} / {{ petProgress().total }}</span>
        </button>
        <button (click)="setActiveTab('resources')" class="w-full text-left px-3 py-2 text-sm rounded-md font-semibold flex items-center justify-between" [class.bg-blue-600/50]="activeTab() === 'resources'" [class.text-white]="activeTab() === 'resources'" [class.hover:bg-gray-700]="activeTab() !== 'resources'" [class.text-gray-300]="activeTab() !== 'resources'">
          <div class="flex items-center gap-2">
             @if(newlyUnlockedMaterialIds().size > 0) { <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span> }
            <span>Resources</span>
          </div>
          <span class="text-xs">{{ materialProgress().unlocked }} / {{ materialProgress().total }}</span>
        </button>
      </nav>
      
      <div class="h-px bg-gray-700"></div>

      <!-- Search -->
      <div class="relative">
        <input type="text" placeholder="Search..." [value]="searchTerm()" (input)="onSearchChange($event)" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2 pl-8 focus:ring-blue-500 focus:border-blue-500">
        <svg class="absolute left-2.5 top-2.5 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
      </div>

      <!-- Filters by Tab -->
      @switch (activeTab()) {
        @case ('heroes') {
          <div class="flex flex-col gap-3 animate-fadeIn" style="animation-duration: 0.2s;">
            <div><label class="text-gray-400 font-semibold text-sm">Rarity:</label><select (change)="onRarityFilterChange($event)" class="mt-1 w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-1.5 focus:ring-blue-500 focus:border-blue-500">@for(rarity of rarities; track rarity) { <option [value]="rarity">{{ rarity }}</option> }</select></div>
            <div><label class="text-gray-400 font-semibold text-sm">Role:</label><select (change)="onRoleFilterChange($event)" class="mt-1 w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-1.5 focus:ring-blue-500 focus:border-blue-500">@for(role of roles; track role) { <option [value]="role">{{ role }}</option> }</select></div>
            <div><label class="text-gray-400 font-semibold text-sm">Sort by:</label><select (change)="onHeroSortChange($event)" class="mt-1 w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-1.5 focus:ring-blue-500 focus:border-blue-500">@for(sort of sortOptions; track sort.value) { <option [value]="sort.value">{{ sort.label }}</option> }</select></div>
          </div>
        }
        @case ('resources') {
           <div class="flex flex-col gap-1 animate-fadeIn" style="animation-duration: 0.2s;">
            <p class="text-gray-400 font-semibold text-sm">Type:</p>
            <div class="flex-grow overflow-y-auto max-h-48 pr-1 no-scrollbar">
                @for(type of materialTypes(); track type) {
                    <button (click)="onMaterialTypeFilterChange(type)" class="w-full text-left text-sm px-2 py-1 rounded-md" [class.bg-blue-600/50]="activeMaterialTypeFilter() === type" [class.hover:bg-gray-700/50]="activeMaterialTypeFilter() !== type">{{ type }}</button>
                }
            </div>
          </div>
        }
      }
    </aside>

    <!-- Main Content Grid -->
    <main class="flex-grow overflow-y-auto p-4">
      @switch (activeTab()) {
        @case ('heroes') {
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            @for (hero of filteredHeroes(); track hero.id) {
              @let unlocked = isHeroUnlocked(hero.id);
              <div (click)="openHeroDetails(hero)" 
                   class="relative bg-gray-900 rounded-lg p-3 flex flex-col items-center justify-center text-center border-2 transition-all duration-300 cursor-pointer hover:-translate-y-1 group" 
                   [class]="unlocked ? getRarityBorderClass(hero.rarity) : 'border-gray-700/50'" 
                   [class.grayscale]="!unlocked"
                   [class.opacity-60]="!unlocked"
                   [class.animate-pulse-glow-cyan]="isHeroNew(hero.id)" 
                   [class.animate-pop-in-soft]="isHeroNew(hero.id)">
                
                @if(isHeroNew(hero.id)) { 
                  <span class="absolute top-1 right-1 bg-cyan-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full z-20 animate-new-badge-pulse">NEW</span> 
                }
                
                <div class="w-20 h-20 rounded-md flex-shrink-0 flex items-center justify-center bg-gray-700/50 border-2 mb-2" 
                     [class]="unlocked ? getRarityBorderClass(hero.rarity) : 'border-gray-700'">
                  @if(unlocked) {
                    <span class="font-orbitron text-3xl text-gray-300">{{ getHeroInitials(hero.name) }}</span>
                  } @else {
                    <svg class="h-10 w-10 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                  }
                </div>
                <h3 class="font-bold text-sm leading-tight"
                    [class.text-white]="unlocked"
                    [class.text-gray-500]="!unlocked">
                    {{ unlocked ? hero.name : 'Unknown Hero' }}
                </h3>
                <p class="text-xs font-semibold" 
                   [class]="unlocked ? getRarityTextColor(hero.rarity) : 'text-gray-600'">
                   {{ unlocked ? hero.rarity : 'Locked' }} {{ unlocked ? hero.role : '' }}
                </p>
              </div>
            } @empty { <p class="col-span-full text-center text-gray-500 italic py-10">No heroes match the current filters.</p> }
          </div>
        }
        @case ('pets') {
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 gap-4">
            @for (pet of allPets; track pet.id) {
              @let unlocked = isPetUnlocked(pet.id);
              <div (click)="openPetDetails(pet)" 
                   class="relative bg-gray-900 rounded-lg p-3 flex flex-col items-center justify-center text-center border-2 transition-all duration-300 cursor-pointer hover:-translate-y-1 group" 
                   [class]="unlocked ? getRarityBorderClass(pet.rarity) : 'border-gray-700/50'"
                   [class.grayscale]="!unlocked"
                   [class.opacity-60]="!unlocked"
                   [class.animate-pulse-glow-cyan]="isPetNew(pet.id)" 
                   [class.animate-pop-in-soft]="isPetNew(pet.id)">
                
                @if(isPetNew(pet.id)) { 
                  <span class="absolute top-1 right-1 bg-cyan-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full z-20 animate-new-badge-pulse">NEW</span> 
                }
                
                <pre class="text-3xl h-20 flex items-center justify-center mb-2 font-mono" 
                     [class]="unlocked ? getRarityTextColor(pet.rarity) : 'text-gray-700'">
                     {{ unlocked ? pet.art : '(?_?)' }}
                </pre>
                <h3 class="font-bold text-sm leading-tight"
                    [class.text-white]="unlocked"
                    [class.text-gray-500]="!unlocked">
                    {{ unlocked ? pet.name : 'Unknown Pet' }}
                </h3>
                <p class="text-xs font-semibold" 
                   [class]="unlocked ? getRarityTextColor(pet.rarity) : 'text-gray-600'">
                   {{ unlocked ? pet.rarity : 'Locked' }}
                </p>
              </div>
            }
          </div>
        }
        @case ('resources') {
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            @for (material of filteredMaterials(); track material.id) {
              @let unlocked = isMaterialUnlocked(material.id);
              <div (click)="openMaterialDetails(material)" 
                   class="relative bg-gray-900 rounded-lg p-3 flex flex-col items-center justify-center text-center border-2 transition-all duration-300 cursor-pointer hover:-translate-y-1 group" 
                   [class]="unlocked ? getRarityBorderClass(material.rarity) : 'border-gray-700/50'"
                   [class.grayscale]="!unlocked"
                   [class.opacity-60]="!unlocked"
                   [class.animate-pulse-glow-cyan]="isMaterialNew(material.id)" 
                   [class.animate-pop-in-soft]="isMaterialNew(material.id)">
                
                @if(isMaterialNew(material.id)) { 
                  <span class="absolute top-1 right-1 bg-cyan-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full z-20 animate-new-badge-pulse">NEW</span> 
                }
                
                <div class="w-20 h-20 rounded-md flex-shrink-0 flex items-center justify-center bg-gray-700/50 border-2 mb-2" 
                     [class]="unlocked ? getRarityBorderClass(material.rarity) : 'border-gray-700'">
                  @if(unlocked) {
                    <span class="text-4xl">{{ getMaterialIcon(material.type) }}</span>
                  } @else {
                    <span class="text-5xl font-bold text-gray-700">?</span>
                  }
                </div>
                <h3 class="font-bold text-sm leading-tight"
                    [class.text-white]="unlocked"
                    [class.text-gray-500]="!unlocked">
                    {{ unlocked ? material.name : 'Unknown' }}
                </h3>
                <p class="text-xs font-semibold" 
                   [class]="unlocked ? getRarityTextColor(material.rarity) : 'text-gray-600'">
                   {{ unlocked ? material.rarity : 'Locked' }} {{ unlocked ? material.type : '' }}
                </p>
              </div>
            } @empty { <p class="col-span-full text-center text-gray-500 italic py-10">No resources match your filters.</p> }
          </div>
        }
      }
    </main>
  </div>
</div>

<!-- Modals -->
@if(isModalOpen()) {
  <div class="absolute inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm" (click)="closeModal()">
    <!-- Hero Details Modal -->
    @if(selectedHeroData(); as data) {
      <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 border-2 animate-modal-fade-in" [class]="getRarityBorderClass(data.hero.rarity)" (click)="$event.stopPropagation()">
        <button (click)="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl">&times;</button>
        @if(data.unlocked) {
          <div [class.shimmer-overlay]="data.isNew">
            <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
              <div class="w-24 h-24 rounded-lg flex-shrink-0 flex items-center justify-center border-4 bg-gray-900/50" [class]="getRarityBorderClass(data.hero.rarity)">
                <span class="font-orbitron text-5xl text-gray-200">{{ getHeroInitials(data.hero.name) }}</span>
              </div>
              <div class="flex-grow text-center sm:text-left">
                <h2 class="font-orbitron text-3xl font-bold text-white">{{ data.hero.name }}</h2>
                <p class="text-lg font-semibold" [class]="getRarityTextColor(data.hero.rarity)">{{ data.hero.rarity }} {{ data.hero.role }}</p>
                <p class="text-sm text-gray-400">Base Class: {{ data.hero.baseClass }}</p>
              </div>
            </div>
            <div class="space-y-2 max-h-[50vh] overflow-y-auto pr-2">
              <div class="bg-gray-900/50 rounded-lg p-3"><h3 class="text-lg font-orbitron text-blue-300 mb-1">Base Stats</h3><div class="grid grid-cols-3 gap-2 text-center text-sm"><div class="bg-black/20 p-1 rounded"><p class="text-gray-400 text-xs">Base DPS</p><p class="font-semibold">‚öîÔ∏è {{ data.hero.baseDps }}</p></div><div class="bg-black/20 p-1 rounded"><p class="text-gray-400 text-xs">Base Cost</p><p class="font-semibold">üí∞ {{ data.hero.baseCost }}</p></div><div class="bg-black/20 p-1 rounded"><p class="text-gray-400 text-xs">Cost Multi</p><p class="font-semibold">üìà x{{ data.hero.upgradeCostMultiplier }}</p></div></div></div>
              <div class="bg-gray-900/50 rounded-lg p-3"><h3 class="text-lg font-orbitron text-blue-300 mb-1">Skill</h3><p class="text-sm text-gray-300">{{ data.hero.skillDescription }}</p></div>
              <div class="bg-gray-900/50 rounded-lg p-3"><h3 class="text-lg font-orbitron text-blue-300 mb-1">Lore</h3><p class="text-sm text-gray-400 italic">{{ data.hero.lore }}</p></div>
            </div>
          </div>
        } @else {
          <div class="text-center p-8">
            <h2 class="text-3xl font-orbitron text-gray-500">DATA CORRUPTED</h2>
            <p class="text-gray-400 mt-4">Unlock this hero to decrypt their information.</p>
          </div>
        }
      </div>
    }

    <!-- Pet Details Modal -->
    @if(selectedPetData(); as data) {
      <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 border-2 animate-modal-fade-in" [class]="getRarityBorderClass(data.pet.rarity)" (click)="$event.stopPropagation()">
        <button (click)="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl">&times;</button>
        @if(data.unlocked) {
          <div [class.shimmer-overlay]="data.isNew">
            <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
              <pre class="text-6xl flex-shrink-0" [class]="getRarityTextColor(data.pet.rarity)">{{ data.pet.art }}</pre>
              <div class="flex-grow text-center sm:text-left"><h2 class="font-orbitron text-3xl font-bold text-white">{{ data.pet.name }}</h2><p class="text-lg font-semibold" [class]="getRarityTextColor(data.pet.rarity)">{{ data.pet.rarity }} Companion</p></div>
            </div>
            <div class="space-y-4"><div class="bg-gray-900/50 rounded-lg p-3"><h3 class="text-xl font-orbitron text-blue-300 mb-1">Bonus</h3><p class="text-sm text-gray-300">{{ data.pet.description }}</p></div><div class="bg-gray-900/50 rounded-lg p-3"><h3 class="text-xl font-orbitron text-blue-300 mb-1">Lore</h3><p class="text-sm text-gray-400 italic">{{ data.pet.lore }}</p></div></div>
          </div>
        } @else {
          <div class="text-center p-8"><h2 class="text-3xl font-orbitron text-gray-500">UNKNOWN COMPANION</h2><p class="text-gray-400 mt-4">Find this pet in a Dungeon to reveal their information.</p></div>
        }
      </div>
    }

    <!-- Material Details Modal -->
    @if(selectedMaterialData(); as data) {
      <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 border-2 animate-modal-fade-in" [class]="getRarityBorderClass(data.material.rarity)" (click)="$event.stopPropagation()">
        <button (click)="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl">&times;</button>
        @if(data.unlocked) {
          <div [class.shimmer-overlay]="data.isNew">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-24 h-24 rounded-lg flex-shrink-0 flex items-center justify-center border-4 text-6xl bg-gray-900/50" [class]="getRarityBorderClass(data.material.rarity)">{{ getMaterialIcon(data.material.type) }}</div>
              <div class="flex-grow"><h2 class="font-orbitron text-3xl font-bold text-white">{{ data.material.name }}</h2><p class="text-lg font-semibold" [class]="getRarityTextColor(data.material.rarity)">{{ data.material.rarity }} {{ data.material.type }}</p></div>
            </div>
            <div class="bg-gray-900/50 rounded-lg p-3"><p class="text-sm text-gray-400 italic">{{ data.material.description }}</p></div>
            <div class="bg-gray-900/50 rounded-lg p-3 mt-2"><h3 class="text-lg font-orbitron text-blue-300 mb-1">Sources</h3><p class="text-sm text-gray-300">{{ getMaterialSources(data.material.type) }}</p></div>
          </div>
        } @else {
          <div class="text-center p-8"><h2 class="text-3xl font-orbitron text-gray-500">UNDISCOVERED</h2><p class="text-gray-400 mt-4">Defeat enemies to discover new materials.</p></div>
        }
      </div>
    }
  </div>
}